services:
  # Nginx Reverse Proxy
  nginx:
    image: nginx:alpine
    container_name: bsv-exchange-nginx
    ports:
      - "8080:80"
    volumes:
      - ./nginx.conf:/etc/nginx/conf.d/default.conf:ro
    restart: unless-stopped
    networks:
      - bsv-network
    depends_on:
      - frontend
      - backend

  # Backend Express Server
  backend:
    build:
      context: .
      dockerfile: server/Dockerfile
    container_name: bsv-exchange-backend
    environment:
      - PORT=3000
      - CHAIN=${CHAIN}
      - STORAGE_URL=${STORAGE_URL}
      - PRIVATE_KEY=${PRIVATE_KEY}
      - MONGODB_URI=mongodb://mongodb:27017/bsv_exchange
      - YENTE_URL=http://open-sanctions-api:8000
    ports:
      - "3000:3000"
    env_file:
      - .env
    restart: unless-stopped
    networks:
      - bsv-network
    depends_on:
      mongodb:
        condition: service_healthy
      open-sanctions-api:
        condition: service_healthy

  # Frontend React App
  frontend:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        - VITE_API_BASE=http://localhost:3000
    restart: unless-stopped
    networks:
      - bsv-network

  # MongoDB Database
  mongodb:
    image: mongo:latest
    container_name: bsv-exchange-mongodb
    ports:
      - "27017:27017"
    environment:
      - MONGO_INITDB_DATABASE=bsv_exchange
    volumes:
      - mongodb_data:/data/db
    restart: unless-stopped
    networks:
      - bsv-network
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5

  open-sanctions-index:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.14.3
    container_name: index
    expose:
      - "9200"
    ports:
      - "127.0.0.1:9200:9200"
    environment:
      - node.name=index
      - cluster.name=opensanctions-index
      - discovery.type=single-node
      - bootstrap.memory_lock=true
      - xpack.security.enabled=false
      - "ES_JAVA_OPTS=-Xms2g -Xmx2g"
    ulimits:
      memlock:
        soft: -1
        hard: -1
    volumes:
      - index-os-data:/usr/share/elasticsearch/data
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:9200/_cluster/health?wait_for_status=yellow&timeout=5s || exit 1"]
      interval: 15s
      timeout: 10s
      retries: 10
      start_period: 30s
    restart: unless-stopped
    networks:
      - bsv-network

  open-sanctions-api:
    image: ghcr.io/opensanctions/yente:5.2.0
    depends_on:
      open-sanctions-index:
        condition: service_healthy
    ports:
      - "127.0.0.1:8000:8000"
    environment:
      YENTE_INDEX_TYPE: "elasticsearch"
      YENTE_INDEX_URL: http://open-sanctions-index:9200
      YENTE_MANIFEST: /app/manifests/civic.yml
      YENTE_UPDATE_TOKEN: "update-token"
      OPENSANCTIONS_DELIVERY_TOKEN: "1ed271531638ac306e61f3193bbdcdc1"
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8000/healthz" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    restart: unless-stopped
    networks:
      - bsv-network

networks:
  bsv-network:
    driver: bridge

volumes:
  index-os-data: null
  mongodb_data:
    driver: local
